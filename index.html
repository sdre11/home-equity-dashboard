<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Home Equity & Treasury Dashboard</title>
<style>
  body {
    font-family: Arial, sans-serif;
    max-width: 700px;
    margin: 20px auto;
    padding: 0 15px 40px 15px;
    background: #f9f9f9;
    color: #222;
  }
  h1, h2 {
    text-align: center;
  }
  .section {
    background: white;
    padding: 20px 25px;
    border-radius: 10px;
    margin-bottom: 30px;
    box-shadow: 0 0 8px rgba(0,0,0,0.1);
  }
  .rate-display {
    font-size: 2rem;
    font-weight: bold;
    text-align: center;
    margin: 10px 0 0 0;
  }
  .green {
    color: #2e7d32;
  }
  .red {
    color: #c62828;
  }
  .black {
    color: #212121;
  }
  /* Chart container */
  #chartContainer {
    max-width: 650px;
    margin: 0 auto 40px auto;
  }
  /* Toggle buttons */
  .toggle-buttons {
    text-align: center;
    margin-bottom: 15px;
  }
  .toggle-buttons button {
    margin: 0 5px;
    padding: 10px 20px;
    border: none;
    background-color: #4CAF50;
    color: white;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
    transition: background-color 0.3s ease;
  }
  .toggle-buttons button.active {
    background-color: #388E3C;
  }
  /* Rate line styling */
  .rate-line {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #eee;
    font-size: 1.1rem;
  }
  /* Limit bar container */
  .limit-bar {
    position: relative;
    height: 16px;
    background: #ddd;
    border-radius: 8px;
    margin-top: 6px;
    max-width: 400px;
    margin-left: auto;
    margin-right: auto;
  }
  .limit-bar .good {
    position: absolute;
    left: 0;
    height: 100%;
    background: #a5d6a7;
    border-radius: 8px 0 0 8px;
  }
  .limit-bar .bad {
    position: absolute;
    right: 0;
    height: 100%;
    width: 20%;
    background: #ef9a9a;
    border-radius: 0 8px 8px 0;
  }
  .limit-bar .rate-indicator {
    position: absolute;
    top: -6px;
    width: 2px;
    height: 28px;
    background: #2e7d32;
  }
  .limit-bar .rate-indicator.red {
    background: #c62828;
  }
</style>
</head>
<body>

<h1>Home Equity & Treasury Dashboard</h1>

<div class="section" id="dailyRates">
  <h2>Today's Average Rates</h2>

  <div class="rate-line">
    <span>HELOC Rate</span>
    <span id="helocRate" class="rate-display black">Loading...</span>
  </div>

  <div class="rate-line">
    <span>Home Equity Loan Rate</span>
    <span id="helLoanRate" class="rate-display black">Loading...</span>
  </div>

  <div class="rate-line">
    <span>10-Year Treasury Yield</span>
    <span id="treasuryRate" class="rate-display black">Loading...</span>
  </div>

  <div id="treasuryLimitBar" class="limit-bar" style="display:none;">
    <div class="good" style="width:60%;"></div>
    <div class="bad"></div>
    <div id="treasuryIndicator" class="rate-indicator"></div>
  </div>
</div>

<div class="section" id="chartSection">
  <h2>HELOC Rate Trends (CME Group Data)</h2>
  <div class="toggle-buttons">
    <button id="btn30" class="active">Last 30 Days</button>
    <button id="btn12">Last 12 Months</button>
  </div>
  <div id="chartContainer">
    <canvas id="rateChart"></canvas>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // Utility: color-code rates based on thresholds
  function colorClassForRate(rate, goodMax, badMin) {
    if (rate === null || isNaN(rate)) return 'black';
    if (rate <= goodMax) return 'green';
    if (rate >= badMin) return 'red';
    return 'black';
  }

  // Function to update a rate display with color
  function updateRateDisplay(id, rate, goodMax, badMin) {
    const el = document.getElementById(id);
    if (rate === null || isNaN(rate)) {
      el.textContent = 'N/A';
      el.className = 'rate-display black';
      return;
    }
    el.textContent = rate.toFixed(3) + '%';
    el.className = 'rate-display ' + colorClassForRate(rate, goodMax, badMin);
  }

  // Fetch Treasury data
  async function fetchTreasury() {
    try {
      const resp = await fetch('https://api.fiscaldata.treasury.gov/services/api/fiscal_service/v2/accounting/od/avg_interest_rates?page[size]=1&page[number]=1&sort=-record_date');
      if (!resp.ok) throw new Error('Network error');
      const json = await resp.json();
      if (!json.data || !json.data.length) return null;

      // Find 10-year treasury rate from data
      const tenYearRecord = json.data.find(rec => rec.security_desc === "Treasury Notes" && rec.record_calendar_year && rec.avg_interest_rate_amt);
      if (!tenYearRecord) return null;

      const rate = parseFloat(tenYearRecord.avg_interest_rate_amt);
      return rate;
    } catch (e) {
      console.error('Fetch Treasury error:', e);
      return null;
    }
  }

  // Update Treasury Limit Bar
  function updateTreasuryLimitBar(rate) {
    const container = document.getElementById('treasuryLimitBar');
    const indicator = document.getElementById('treasuryIndicator');
    const goodMax = 3.5;
    const badMin = 4.5;

    if (rate === null || isNaN(rate)) {
      container.style.display = 'none';
      return;
    }
    container.style.display = 'block';

    // Bar width is 100%, "good" zone 0-3.5 (70%), "bad" zone 4.5-5+ (20%) - simplified here
    const totalRange = 6; // assume 0-6%
    const goodPercent = (goodMax / totalRange) * 100; // ~58%
    const badPercent = ((totalRange - badMin) / totalRange) * 100; // ~25%

    container.querySelector('.good').style.width = goodPercent + '%';
    container.querySelector('.bad').style.width = badPercent + '%';

    // Position indicator (clamp to 0-100%)
    let posPercent = (rate / totalRange) * 100;
    if (posPercent < 0) posPercent = 0;
    if (posPercent > 100) posPercent = 100;
    indicator.style.left = posPercent + '%';

    // Color indicator
    if (rate <= goodMax) indicator.className = 'rate-indicator green';
    else if (rate >= badMin) indicator.className = 'rate-indicator red';
    else indicator.className = 'rate-indicator black';
  }

  // Simulated fetch for HELOC and Home Equity Loan - replace these with real APIs when available
  async function fetchHeloc() {
    // Simulate random value between 5.5 and 7.5
    return 5.5 + Math.random() * 2;
  }
  async function fetchHelLoan() {
    // Simulate random value between 6.0 and 8.0
    return 6.0 + Math.random() * 2;
  }

  // Update all rates daily
  async function updateRates() {
    const heloc = await fetchHeloc();
    updateRateDisplay('helocRate', heloc, 6.0, 7.0);

    const helLoan = await fetchHelLoan();
    updateRateDisplay('helLoanRate', helLoan, 6.5, 7.5);

    const treasury = await fetchTreasury();
    updateRateDisplay('treasuryRate', treasury, 3.5, 4.5);
    updateTreasuryLimitBar(treasury);
  }

  // === CME Chart Section ===
  const ctx = document.getElementById('rateChart').getContext('2d');
  let currentChart;

  // Format date labels for chart x-axis
  function formatDateLabel(dateStr, daysCount) {
    const d = new Date(dateStr);
    if (daysCount <= 31) {
      return `${d.getMonth() + 1}/${d.getDate()}`;
    } else {
      return d.toLocaleString('default', { month: 'short', year: '2-digit' });
    }
  }

  // Fetch CME Group futures data via proxy
  async function fetchCMEData(days) {
    // CME Group Futures contract 438 (example)
    const baseUrl = `https://www.cmegroup.com/CmeWS/mvc/Quotes/Futures/438/G?pageSize=${days}&pageNumber=1&sortField=tradeDate&sortOrder=DESC`;

    // Use free CORS proxy (for demo only)
    const proxyUrl = 'https://api.allorigins.win/get?url=' + encodeURIComponent(baseUrl);

    try {
      const response = await fetch(proxyUrl);
      if (!response.ok) throw new Error('Network response not ok');
      const textData = await response.json();
      // Proxy returns { contents: "<raw JSON>" }
      const cmeData = JSON.parse(textData.contents);

      if (!cmeData.quotes) throw new Error('No quotes data');

      // Sort oldest to newest
      const sortedQuotes = cmeData.quotes.sort((a,b) => new Date(a.tradeDate) - new Date(b.tradeDate));

      const labels = sortedQuotes.map(q => formatDateLabel(q.tradeDate, days));
      const rates = sortedQuotes.map(q => parseFloat(q.settlementPrice));

      return { labels, rates };
    } catch (err) {
      console.error('Error fetching CME data:', err);
      return null;
    }
  }

  // Create or update Chart.js line chart
  function createChart(labels, data, daysCount) {
    if (currentChart) currentChart.destroy();

    currentChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'HELOC Rate (%)',
          data,
          borderColor: '#4CAF50',
          backgroundColor: 'rgba(76, 175, 80, 0.2)',
          fill: true,
          tension: 0.2,
          pointRadius: 2,
          pointHoverRadius: 5,
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: false,
            min: Math.min(...data) - 1,
            max: Math.max(...data) + 1,
            title: { display: true, text: 'Rate (%)' }
          },
          x: {
            title: { display: true, text: daysCount <= 31 ? 'Date' : 'Month' }
          }
        }
      }
    });
  }

  // Load and display chart data for given days count
  async function loadChart(daysCount) {
    document.getElementById('btn30').classList.toggle('active', daysCount === 30);
    document.getElementById('btn12').classList.toggle('active', daysCount === 365);

    const data = await fetchCMEData(daysCount);
    if (data) {
      createChart(data.labels, data.rates, daysCount);
    } else {
      ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
      ctx.font = '16px Arial';
      ctx.fillStyle = '#999';
      ctx.textAlign = 'center';
      ctx.fillText('Failed to load data', ctx.canvas.width / 2, ctx.canvas.height / 2);
    }
  }

  // Setup toggle buttons
  document.getElementById('btn30').onclick = () => loadChart(30);
  document.getElementById('btn12').onclick = () => loadChart(365);

  // Initial load
  updateRates();
  loadChart(30);

  // Optionally refresh daily rates every hour
  setInterval(updateRates, 1000 * 60 * 60);
</script>

</body>
</html>
